<script>
dojo.require("dijit.form.Form");
dojo.require("dijit.form.ValidationTextBox");
dojo.require("dijit.form.Button");
dojo.addOnLoad(SetFocus);
function SetFocus() {
    //find controls.
    var tbUsername = dojo.byId("tbUsername");
    //set focus.
    tbUsername.focus();
}
function SubmitLoginForm(fields) {
    //ajax call.
    var request = { "iz_username": fields.tbUsername, "iz_password": fields.tbPassword };
    Post("<?php echo config('root.url_json');?>auth/login/", request, FormResult);
}
function FormResult(result) {
	console.debug(result);
    if (result.success === false) {
        console.debug('Login success')
    }
    else {
        //redirect.
		console.debug(result);
        //window.location = result;
    }
}

var maxAjaxCalls = 5;
var currentAjaxCalls = new Array();
 
function Post(path, request, callbackFunction) {
    //increment current ajax calls.
    currentAjaxCalls[currentAjaxCalls.length] = path;
    //make sure hasn't gone over max ajax calls.
    var numAjaxCall = NumAjaxCalls(path);
    if (numAjaxCall <= maxAjaxCalls) {
        if (numAjaxCall > 1) {
            console.debug("Invoking " + path + " ajax call for try #" + numAjaxCall);
        }
        dojo.xhrPost({
            url: '<iz:insert:url/>' + path,
            handleAs: 'json',
            timeout: 60000,
            content: request,
            contentType: "application/x-www-form-urlencoded",
            load: function(result) { PostSuccess(result, path, callbackFunction); },
            error: function(error, args) { AjaxError(error, args, path, request, callbackFunction); }
        });
    }
    else {
        console.debug("Tried to make " + path + " ajax call " + maxAjaxCalls + " times but failed!");
    }
}
 
function NumAjaxCalls(path) {
    var numAjaxCalls = 0;
    for (var k = 0; k < currentAjaxCalls.length; k++) {
        if (currentAjaxCalls[k] == path) {
            numAjaxCalls++;
        }
    }
    return numAjaxCalls;
}
 
function PostSuccess(result, path, callbackFunction) {
    //remove path from array.
    for (var k = 0; k < currentAjaxCalls.length; k++) {
        if (currentAjaxCalls[k] == path) {
            currentAjaxCalls.splice(k, 1);
            k--;
        }
    }
    //invoke callback function.
    callbackFunction(result);
}
 
function AjaxError(error, args, path, request, callbackFunction) {
    //show error message.
    console.debug("ajax error: " + error.message + " " + error.responseText);
    //console.debug(error);
    //try ajax call again in 1 second.
    //window.setTimeout(function() { Post(path, request, callbackFunction); }, 1000);
}

</script>
<div id="loginBanner"></div>
<div id="loginPanel">
	<div dojoType="dijit.form.Form" jsId="loginForm" encType="multipart/form-data" action="" method="">
	    <script type="dojo/method" event="onSubmit">
	        if (this.validate()) {
	            SubmitLoginForm(loginForm.getValues());
	        }
	        return false;
	    </script>
		<div id="loginContent">
	    	<table cellspacing="0">
		        <tr>
		            <td class="label">Username:</td>
		            <td class="input mediumfield">
		                <input id="tbUsername" name="tbUsername" type="text" size="20"
		                    dojoType="dijit.form.ValidationTextBox"
		                    required="true"
		                    promptMessage="Enter Username."
		                    invalidMessage="Username is required." />
		            </td>
		        </tr>
		        <tr>
		            <td class="label">Password:</td>
		            <td class="input mediumfield">
		                <input id="tbPassword" name="tbPassword" type="password" size="20"
		                    dojoType="dijit.form.ValidationTextBox"
		                    required="true"
		                    promptMessage="Enter Password."
		                    invalidMessage="Password is required." />
		            </td>
		        </tr>
				<tr>
					<td></td>
					<td><button dojoType="dijit.form.Button" type="submit" value="Submit" iconClass="iconLogin">Login</button></td>
				</tr>	
		    </table>
		</div>
	</div>
</div>